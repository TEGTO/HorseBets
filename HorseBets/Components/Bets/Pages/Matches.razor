@page "/matches"
@using HorseBets.Bets.Models
@using HorseBets.Bets.Services
@using HorseBets.Components.Bets.Shared
@using HorseBets.Components.Bets.Shared.Matches
@using HorseBets.Components.Shared
@using HorseBets.Data
@using Microsoft.AspNetCore.Identity

@inject IMatchService MatchService
@rendermode InteractiveServer

@inherits GetClient

<PageTitle>Matches</PageTitle>
@if (matchesOnPage == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <div class="container">
        <div class="match-grid">
            @foreach (var match in matchesOnPage)
            {
                <div class="match-content">
                    <Match MatchObject="@match" Client="@Client"></Match>
                </div>
            }
        </div>
        <div class="paginator">
            <PagePagination CurrentPageNumber="currentPageNumber" MaxShowPagesOnEachSide="maxShowPages" TotalPages="totalPages" OnChangePage="OnChangePage" />
        </div>
    </div>
}

@code {
    private int pageSize = 6;
    private int currentPageNumber = 1;
    private int totalPages = 200;
    private int maxShowPages = 5;
    private IEnumerable<HorseBets.Bets.Models.Match> matchesOnPage = null!;

    protected event Action<int> OnChangePage = default!;

    protected override void OnInitialized()
    {
        OnChangePage += ChangePage;
    }
    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await SetPagesAsync();
    }
    private async Task SetPagesAsync()
    {
        totalPages = await MatchService.GetTotalAmountOfPagesAsync(pageSize);
        ChangePage(1);
    }
    private async void ChangePage(int page)
    {
        currentPageNumber = page;
        matchesOnPage = await MatchService.GetMatchesOnPageAsync(currentPageNumber, pageSize);
        await InvokeAsync(StateHasChanged);
    }
}